<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scan</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <script>
    let currentUrl  = window.location.href;
  </script>
  <style>
    .board {
      position: relative;
      background-color: #F0F8FF;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      border-radius: 3px;
      padding-bottom: 20px;
      text-align: center;
    }

    .js-bookmark {
      position: absolute;
      top: 65px;
      right: 30px;
    }
    .img-favorite {
      animation-duration: 2s;
      animation-iteration-count: infinite;
      animation-name: img-favorite;
      animation-timing-function: linear;
    }

    @keyframes img-favorite {
        0%   { transform: scale(1,1)    translateY(0); }
        10%  { transform: scale(1.1,.9) translateY(0); }
        30%  { transform: scale(.9,1.1) translateY(-10px); }
        50%  { transform: scale(1,1)    translateY(0); }
        57%  { transform: scale(1,1)    translateY(-4px); }
        64%  { transform: scale(1,1)    translateY(0); }
        100% { transform: scale(1,1)    translateY(0); }
    }
  </style>
</head>
<body style="background-color: #3487C9; color: #444;">
  <div class="container">
    <div class="row" style="margin-top: 80px;">
      <div class="col-sm-12 board">
        <div style="position: absolute; top: -50px; text-align: center; width: 100%;">
            <img src="https://github.com/svfcode/ct-sec-scan/blob/main/logo.png?raw=true" alt="Cleantalk logo" style="height: 100px;">
            <a href=`${currentUrl}` class="js-bookmark" title="Adding to bookmarks">
              <img width="35" height="35" src="https://img.icons8.com/fluency/48/star--v2.png" alt="star--v2" class="img-favorite"/>
            </a>
        </div>
        <div style="text-align: center; margin-top: 70px;">
            <h3> - Cleantalk Security Scanner - </h3>
        </div>
        <div class="mt-4" style="text-align: center; width: 100%;">
          <button type="button" class="btn btn-primary">Perform scan</button>
        </div>

        <div class="progress mt-4 center" style="width: 75%; margin-left: 12%;" role="progressbar" aria-label="Example with label" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
          <div id="progress_main" class="progress-bar" style="width: 25%">25%</div>
        </div>

        <div class="card mt-4">
        <p id="help_text" class="mt-2">Process of scanning, please don't leave this page.</p>
          <div class="card-body">
            <table id="verdict" class="table table-striped d-none">
              <tr>
                <th>path</th>
                <th>detected</th>
                <th>last modified</th>
              </tr>
            </table>
          </div>
          <div id="progress_log" class="card-body">
            <div class="card" style="max-height: 300px; overflow: auto;">
              <table class="table table-striped-columns">
                <tr>
                  <th>stage</th>
                  <th>result</th>
                  <th>duration</th>
                </tr>
                <tr>
                  <td>receiving signatures from cloud</td>
                  <td>
                    <div class="progress mt-4 center" role="progressbar" aria-label="Example with label" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                      <div class="progress-bar" style="width: 25%">25%</div>
                    </div>
                  </td>
                  <td>1s</td>
                </tr>
                <tr>
                  <td>prepare file system</td>
                  <td>
                    <div class="progress mt-4 center" role="progressbar" aria-label="Example with label" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                      <div class="progress-bar" style="width: 25%">25%</div>
                    </div>
                  </td>
                  <td>1s</td>
                </tr>
                <tr>
                  <td>check signatures</td>
                  <td>
                    <div class="progress mt-4 center" role="progressbar" aria-label="Example with label" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
                      <div class="progress-bar" style="width: 25%">25%</div>
                    </div>
                  </td>
                  <td>1s</td>
                </tr>
              </table>
          </div>
        </div>

      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script>
    let verdict = [];
    function runStage(stage) {
      $.ajax({
          url: document.location.href,
          method: 'POST',
          dataType: 'json',
          async: false,
          data: {
            "method": stage
          },
          success: function(data){
            console.log(data)
            if (stage === 'check_signatures') {
              verdict = data['verdict'];
            }
          },
          error: function(a, b, c) {
            console.log(a,b,c)
          }
      });
    }

    function renderVerdict() {
      console.log(verdict);

      $('#progress_log').addClass('d-none');
      $('#verdict').removeClass('d-none');
      $('#progress_main').width('100%');
      $('#progress_main').text('100%');

      if (verdict.length > 0) {
        let txt = 'You have a malware on site, please use <a href="https://cleantalk.org/help/install-uniforce-security" target="_blank">Uniforce</a> full version to detect and autocure malweres.';
        $('#help_text').html(txt).css({'color': 'red'});
      }

      let content = '';
      let d, minutes, seconds, date;
      shortMonthName = new Intl.DateTimeFormat("en-US", { month: "short" }).format;
      verdict.forEach(el => {
        d = new Date(Number(el[2]) * 1000);
        minutes = String(d.getMinutes()).padStart(2, '0');
        seconds = String(d.getSeconds()).padStart(2, '0');
        date = shortMonthName(d) + ' ' + d.getDate() + ' ' + d.getFullYear() + ' ' + d.getHours() + ':' + minutes + ':' + seconds;

        content += [
          '<tr>',
          '<td>',
          el[0],
          '</td>',
          '<td>',
          el[1],
          '</td>',
          '<td>',
          date,
          '</td>',
          '</td>',
        ].join('');
      });
      $('#verdict tr:last').after(content);
    }

    let stages = [
      'prepare_file_system',
      'receive_signatures',
      'make_file_system_cast',
      'check_signatures',
    ];

    $(document).ready(function() {
      stages.forEach(stage => {
        runStage(stage);
      });

      if (verdict.length > 0) {
        renderVerdict();
      }

      // Adding to bookmarks
      let triggerBookmark = $(".js-bookmark");
      triggerBookmark.click(function() {
        if (window.sidebar && window.sidebar.addPanel) { // Firefox <23
            window.sidebar.addPanel(document.title,window.location.href,'');
        } else if (window.external && ('AddFavorite' in window.external)) {
            // Internet Explorer
            window.external.AddFavorite(location.href,document.title); 
        } else if (window.opera && window.print || window.sidebar && ! (window.sidebar instanceof Node)) {
            // Opera <15 Ð¸ Firefox >23
            triggerBookmark.attr('rel', 'sidebar').attr('title', document.title);
            return true;
        } else { 
            alert('You can bookmark this page by pressing ' + (navigator.userAgent.toLowerCase().indexOf('mac') != - 1 ? 'Command/Cmd' : 'CTRL') + ' + D on your keyboard.');
        }
        return false;
      });
    });
  </script>
</body>
</html>